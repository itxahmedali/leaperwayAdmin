import { NodeSelection, Plugin, PluginKey } from 'prosemirror-state';
const WRAPPER_CLASSNAME = 'NgxEditor__ImageWrapper';
const WRAPPER_RESIZE_ACTIVE_CLASSNAME = 'NgxEditor__Resizer--Active';
const RESIZE_HANDLE_CLASSNAME = 'NgxEditor__ResizeHandle';
const createHandle = (direction) => {
    const handle = document.createElement('span');
    handle.className = `${RESIZE_HANDLE_CLASSNAME}--${direction}`;
    return handle;
};
const ɵ0 = createHandle;
class ImageRezieView {
    constructor(node, view, getPos) {
        var _a, _b;
        const outer = document.createElement('span');
        outer.className = WRAPPER_CLASSNAME;
        outer.style.width = node.attrs.width;
        const handle = document.createElement('span');
        handle.className = RESIZE_HANDLE_CLASSNAME;
        const img = document.createElement('img');
        img.setAttribute('src', node.attrs.src);
        img.setAttribute('alt', (_a = node.attrs.alt) !== null && _a !== void 0 ? _a : '');
        img.setAttribute('title', (_b = node.attrs.title) !== null && _b !== void 0 ? _b : '');
        img.style.width = '100%';
        const handleBottomRight = createHandle('BR');
        const handleTopRight = createHandle('TL');
        const handleTopLeft = createHandle('TR');
        const handleBottomLeft = createHandle('BL');
        const resizePropoptionally = (evt) => {
            evt.preventDefault();
            const { state, dispatch } = view;
            const { tr } = state;
            const startX = evt.pageX;
            const startWidth = img.clientWidth;
            const { width } = window.getComputedStyle(view.dom);
            const editorWidth = parseInt(width, 10);
            const onMouseMove = (e) => {
                const currentX = e.pageX;
                const diffInPx = currentX - startX;
                const computedWidth = startWidth + diffInPx;
                // prevent image overflow the editor
                // prevent resizng below 20px
                if (computedWidth > editorWidth || computedWidth < 20) {
                    return;
                }
                outer.style.width = `${computedWidth}px`;
            };
            const onMouseUp = (e) => {
                e.preventDefault();
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                const transaction = tr.setNodeMarkup(getPos(), null, {
                    src: node.attrs.src,
                    width: outer.style.width
                });
                const resolvedPos = transaction.doc.resolve(getPos());
                const newSelection = new NodeSelection(resolvedPos);
                transaction.setSelection(newSelection);
                dispatch(transaction);
            };
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        };
        handleBottomRight.addEventListener('mousedown', resizePropoptionally, { once: true });
        handleTopRight.addEventListener('mousedown', resizePropoptionally, { once: true });
        handleTopLeft.addEventListener('mousedown', resizePropoptionally, { once: true });
        handleBottomLeft.addEventListener('mousedown', resizePropoptionally, { once: true });
        handle.appendChild(handleBottomRight);
        handle.appendChild(handleTopRight);
        handle.appendChild(handleTopLeft);
        handle.appendChild(handleBottomLeft);
        outer.appendChild(handle);
        outer.appendChild(img);
        this.dom = outer;
        this.img = img;
        this.handle = handle;
    }
    selectNode() {
        this.dom.classList.add(WRAPPER_RESIZE_ACTIVE_CLASSNAME);
        this.handle.style.display = 'block';
    }
    deselectNode() {
        this.dom.classList.remove(WRAPPER_RESIZE_ACTIVE_CLASSNAME);
        this.handle.style.display = 'none';
    }
}
const defaultOptions = {
    resize: true,
};
const imagePlugin = (opts = defaultOptions) => {
    const options = Object.assign(Object.assign({}, defaultOptions), opts);
    return new Plugin({
        key: new PluginKey('link'),
        props: {
            nodeViews: {
                image: (node, view, getPos) => {
                    if (!options.resize) {
                        return null;
                    }
                    return new ImageRezieView(node, view, getPos);
                },
            }
        }
    });
};
const ɵ1 = imagePlugin;
export default imagePlugin;
export { ɵ0, ɵ1 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4vc3JjL3BsdWdpbnMvIiwic291cmNlcyI6WyJpbWFnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUdyRSxNQUFNLGlCQUFpQixHQUFHLHlCQUF5QixDQUFDO0FBQ3BELE1BQU0sK0JBQStCLEdBQUcsNEJBQTRCLENBQUM7QUFDckUsTUFBTSx1QkFBdUIsR0FBRyx5QkFBeUIsQ0FBQztBQUUxRCxNQUFNLFlBQVksR0FBRyxDQUFDLFNBQWlCLEVBQWUsRUFBRTtJQUN0RCxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzlDLE1BQU0sQ0FBQyxTQUFTLEdBQUcsR0FBRyx1QkFBdUIsS0FBSyxTQUFTLEVBQUUsQ0FBQztJQUM5RCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLENBQUM7O0FBRUYsTUFBTSxjQUFjO0lBS2xCLFlBQVksSUFBcUIsRUFBRSxJQUFnQixFQUFFLE1BQW9COztRQUN2RSxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzdDLEtBQUssQ0FBQyxTQUFTLEdBQUcsaUJBQWlCLENBQUM7UUFDcEMsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7UUFFckMsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM5QyxNQUFNLENBQUMsU0FBUyxHQUFHLHVCQUF1QixDQUFDO1FBRTNDLE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDMUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxH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QVMsQ0FBQyxNQUFNLENBQUMsK0JBQStCLENBQUMsQ0FBQztRQUMzRCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO0lBQ3JDLENBQUM7Q0FDRjtBQUVELE1BQU0sY0FBYyxHQUFHO0lBQ3JCLE1BQU0sRUFBRSxJQUFJO0NBQ2IsQ0FBQztBQUVGLE1BQU0sV0FBVyxHQUFHLENBQUMsSUFBSSxHQUFHLGNBQWMsRUFBVSxFQUFFO0lBQ3BELE1BQU0sT0FBTyxtQ0FBUSxjQUFjLEdBQUssSUFBSSxDQUFFLENBQUM7SUFFL0MsT0FBTyxJQUFJLE1BQU0sQ0FBQztRQUNoQixHQUFHLEVBQUUsSUFBSSxTQUFTLENBQUMsTUFBTSxDQUFDO1FBQzFCLEtBQUssRUFBRTtZQUNMLFNBQVMsRUFBRTtnQkFDVCxLQUFLLEVBQUUsQ0FBQyxJQUFxQixFQUFFLElBQWdCLEVBQUUsTUFBb0IsRUFBRSxFQUFFO29CQUN2RSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRTt3QkFDbkIsT0FBTyxJQUFJLENBQUM7cUJBQ2I7b0JBQ0QsT0FBTyxJQUFJLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUNoRCxDQUFDO2FBQ0Y7U0FDRjtLQUNGLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQzs7QUFFRixlQUFlLFdBQVcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5vZGUgYXMgUHJvc2VtaXJyb3JOb2RlIH0gZnJvbSAncHJvc2VtaXJyb3ItbW9kZWwnO1xuaW1wb3J0IHsgTm9kZVNlbGVjdGlvbiwgUGx1Z2luLCBQbHVnaW5LZXkgfSBmcm9tICdwcm9zZW1pcnJvci1zdGF0ZSc7XG5pbXBvcnQgeyBFZGl0b3JWaWV3IH0gZnJvbSAncHJvc2VtaXJyb3Itdmlldyc7XG5cbmNvbnN0IFdSQVBQRVJfQ0xBU1NOQU1FID0gJ05neEVkaXRvcl9fSW1hZ2VXcmFwcGVyJztcbmNvbnN0IFdSQVBQRVJfUkVTSVpFX0FDVElWRV9DTEFTU05BTUUgPSAnTmd4RWRpdG9yX19SZXNpemVyLS1BY3RpdmUnO1xuY29uc3QgUkVTSVpFX0hBTkRMRV9DTEFTU05BTUUgPSAnTmd4RWRpdG9yX19SZXNpemVIYW5kbGUnO1xuXG5jb25zdCBjcmVhdGVIYW5kbGUgPSAoZGlyZWN0aW9uOiBzdHJpbmcpOiBIVE1MRWxlbWVudCA9PiB7XG4gIGNvbnN0IGhhbmRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcbiAgaGFuZGxlLmNsYXNzTmFtZSA9IGAke1JFU0laRV9IQU5ETEVfQ0xBU1NOQU1FfS0tJHtkaXJlY3Rpb259YDtcbiAgcmV0dXJuIGhhbmRsZTtcbn07XG5cbmNsYXNzIEltYWdlUmV6aWVWaWV3IHtcbiAgaW1nOiBIVE1MRWxlbWVudDtcbiAgZG9tOiBIVE1MRWxlbWVudDtcbiAgaGFuZGxlOiBIVE1MRWxlbWVudDtcblxuICBjb25zdHJ1Y3Rvcihub2RlOiBQcm9zZW1pcnJvck5vZGUsIHZpZXc6IEVkaXRvclZpZXcsIGdldFBvczogKCkgPT4gbnVtYmVyKSB7XG4gICAgY29uc3Qgb3V0ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XG4gICAgb3V0ZXIuY2xhc3NOYW1lID0gV1JBUFBFUl9DTEFTU05BTUU7XG4gICAgb3V0ZXIuc3R5bGUud2lkdGggPSBub2RlLmF0dHJzLndpZHRoO1xuXG4gICAgY29uc3QgaGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICAgIGhhbmRsZS5jbGFzc05hbWUgPSBSRVNJWkVfSEFORExFX0NMQVNTTkFNRTtcblxuICAgIGNvbnN0IGltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpO1xuICAgIGltZy5zZXRBdHRyaWJ1dGUoJ3NyYycsIG5vZGUuYXR0cnMuc3JjKTtcbiAgICBpbWcuc2V0QXR0cmlidXRlKCdhbHQnLCBub2RlLmF0dHJzLmFsdCA/PyAnJyk7XG4gICAgaW1nLnNldEF0dHJpYnV0ZSgndGl0bGUnLCBub2RlLmF0dHJzLnRpdGxlID8/ICcnKTtcbiAgICBpbWcuc3R5bGUud2lkdGggPSAnMTAwJSc7XG5cbiAgICBjb25zdCBoYW5kbGVCb3R0b21SaWdodCA9IGNyZWF0ZUhhbmRsZSgnQlInKTtcbiAgICBjb25zdCBoYW5kbGVUb3BSaWdodCA9IGNyZWF0ZUhhbmRsZSgnVEwnKTtcbiAgICBjb25zdCBoYW5kbGVUb3BMZWZ0ID0gY3JlYXRlSGFuZGxlKCdUUicpO1xuICAgIGNvbnN0IGhhbmRsZUJvdHRvbUxlZnQgPSBjcmVhdGVIYW5kbGUoJ0JMJyk7XG5cbiAgICBjb25zdCByZXNpemVQcm9wb3B0aW9uYWxseSA9IChldnQ6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICBjb25zdCB7IHN0YXRlLCBkaXNwYXRjaCB9ID0gdmlldztcbiAgICAgIGNvbnN0IHsgdHIgfSA9IHN0YXRlO1xuXG4gICAgICBjb25zdCBzdGFydFggPSBldnQucGFnZVg7XG4gICAgICBjb25zdCBzdGFydFdpZHRoID0gaW1nLmNsaWVudFdpZHRoO1xuXG4gICAgICBjb25zdCB7IHdpZHRoIH0gPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh2aWV3LmRvbSk7XG4gICAgICBjb25zdCBlZGl0b3JXaWR0aCA9IHBhcnNlSW50KHdpZHRoLCAxMCk7XG5cbiAgICAgIGNvbnN0IG9uTW91c2VNb3ZlID0gKGU6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgY29uc3QgY3VycmVudFggPSBlLnBhZ2VYO1xuICAgICAgICBjb25zdCBkaWZmSW5QeCA9IGN1cnJlbnRYIC0gc3RhcnRYO1xuICAgICAgICBjb25zdCBjb21wdXRlZFdpZHRoID0gc3RhcnRXaWR0aCArIGRpZmZJblB4O1xuXG4gICAgICAgIC8vIHByZXZlbnQgaW1hZ2Ugb3ZlcmZsb3cgdGhlIGVkaXRvclxuICAgICAgICAvLyBwcmV2ZW50IHJlc2l6bmcgYmVsb3cgMjBweFxuICAgICAgICBpZiAoY29tcHV0ZWRXaWR0aCA+IGVkaXRvcldpZHRoIHx8IGNvbXB1dGVkV2lkdGggPCAyMCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIG91dGVyLnN0eWxlLndpZHRoID0gYCR7Y29tcHV0ZWRXaWR0aH1weGA7XG4gICAgICB9O1xuXG4gICAgICBjb25zdCBvbk1vdXNlVXAgPSAoZTogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgb25Nb3VzZU1vdmUpO1xuICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgb25Nb3VzZVVwKTtcblxuICAgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IHRyLnNldE5vZGVNYXJrdXAoZ2V0UG9zKCksIG51bGwsIHtcbiAgICAgICAgICBzcmM6IG5vZGUuYXR0cnMuc3JjLFxuICAgICAgICAgIHdpZHRoOiBvdXRlci5zdHlsZS53aWR0aFxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCByZXNvbHZlZFBvcyA9IHRyYW5zYWN0aW9uLmRvYy5yZXNvbHZlKGdldFBvcygpKTtcbiAgICAgICAgY29uc3QgbmV3U2VsZWN0aW9uID0gbmV3IE5vZGVTZWxlY3Rpb24ocmVzb2x2ZWRQb3MpO1xuXG4gICAgICAgIHRyYW5zYWN0aW9uLnNldFNlbGVjdGlvbihuZXdTZWxlY3Rpb24pO1xuICAgICAgICBkaXNwYXRjaCh0cmFuc2FjdGlvbik7XG4gICAgICB9O1xuXG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBvbk1vdXNlTW92ZSk7XG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgb25Nb3VzZVVwKTtcbiAgICB9O1xuXG4gICAgaGFuZGxlQm90dG9tUmlnaHQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgcmVzaXplUHJvcG9wdGlvbmFsbHksIHsgb25jZTogdHJ1ZSB9KTtcbiAgICBoYW5kbGVUb3BSaWdodC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCByZXNpemVQcm9wb3B0aW9uYWxseSwgeyBvbmNlOiB0cnVlIH0pO1xuICAgIGhhbmRsZVRvcExlZnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgcmVzaXplUHJvcG9wdGlvbmFsbHksIHsgb25jZTogdHJ1ZSB9KTtcbiAgICBoYW5kbGVCb3R0b21MZWZ0LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHJlc2l6ZVByb3BvcHRpb25hbGx5LCB7IG9uY2U6IHRydWUgfSk7XG5cbiAgICBoYW5kbGUuYXBwZW5kQ2hpbGQoaGFuZGxlQm90dG9tUmlnaHQpO1xuICAgIGhhbmRsZS5hcHBlbmRDaGlsZChoYW5kbGVUb3BSaWdodCk7XG4gICAgaGFuZGxlLmFwcGVuZENoaWxkKGhhbmRsZVRvcExlZnQpO1xuICAgIGhhbmRsZS5hcHBlbmRDaGlsZChoYW5kbGVCb3R0b21MZWZ0KTtcblxuICAgIG91dGVyLmFwcGVuZENoaWxkKGhhbmRsZSk7XG4gICAgb3V0ZXIuYXBwZW5kQ2hpbGQoaW1nKTtcblxuICAgIHRoaXMuZG9tID0gb3V0ZXI7XG4gICAgdGhpcy5pbWcgPSBpbWc7XG4gICAgdGhpcy5oYW5kbGUgPSBoYW5kbGU7XG4gIH1cblxuICBzZWxlY3ROb2RlKCk6IHZvaWQge1xuICAgIHRoaXMuZG9tLmNsYXNzTGlzdC5hZGQoV1JBUFBFUl9SRVNJWkVfQUNUSVZFX0NMQVNTTkFNRSk7XG4gICAgdGhpcy5oYW5kbGUuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gIH1cblxuICBkZXNlbGVjdE5vZGUoKTogdm9pZCB7XG4gICAgdGhpcy5kb20uY2xhc3NMaXN0LnJlbW92ZShXUkFQUEVSX1JFU0laRV9BQ1RJVkVfQ0xBU1NOQU1FKTtcbiAgICB0aGlzLmhhbmRsZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICB9XG59XG5cbmNvbnN0IGRlZmF1bHRPcHRpb25zID0ge1xuICByZXNpemU6IHRydWUsXG59O1xuXG5jb25zdCBpbWFnZVBsdWdpbiA9IChvcHRzID0gZGVmYXVsdE9wdGlvbnMpOiBQbHVnaW4gPT4ge1xuICBjb25zdCBvcHRpb25zID0geyAuLi5kZWZhdWx0T3B0aW9ucywgLi4ub3B0cyB9O1xuXG4gIHJldHVybiBuZXcgUGx1Z2luKHtcbiAgICBrZXk6IG5ldyBQbHVnaW5LZXkoJ2xpbmsnKSxcbiAgICBwcm9wczoge1xuICAgICAgbm9kZVZpZXdzOiB7XG4gICAgICAgIGltYWdlOiAobm9kZTogUHJvc2VtaXJyb3JOb2RlLCB2aWV3OiBFZGl0b3JWaWV3LCBnZXRQb3M6ICgpID0+IG51bWJlcikgPT4ge1xuICAgICAgICAgIGlmICghb3B0aW9ucy5yZXNpemUpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gbmV3IEltYWdlUmV6aWVWaWV3KG5vZGUsIHZpZXcsIGdldFBvcyk7XG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgfVxuICB9KTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGltYWdlUGx1Z2luO1xuIl19